import Control.Monad.Fix
import Control.Monad.Free

type Partiality a = Free Maybe a

never :: Partiality a
never = fix $ Free . Just

fromMaybe :: Maybe a -> Partiality a
fromMaybe (Just x) = Pure x
fromMaybe Nothing = Free Nothing

runPartiality :: Int -> Partiality a -> Maybe a
runPartiality 0 _ = Nothing
runPartiality _ (Pure a) = Just a
runPartiality _ (Free Nothing) = Nothing
runPartiality n (Free (Just a)) = runPartiality (n - 1) a

ack :: Int -> Int -> Partiality Int
ack 0 n = Pure $ n + 1
ack m 0 = Free $ Just $ ack (m - 1) 1
ack m n = Free $ Just $ ack m (n - 1) >>= ack (m - 1)

main :: IO ()
main = do
    let diverge = never :: Partiality ()
    print $ runPartiality 1000 diverge
    print $ runPartiality 1000 (ack 3 4)
    print $ runPartiality 5500 (ack 3 4)
